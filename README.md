# MyProxy - HTTP/HTTPS Прокси-сервер

## Описание
MyProxy - это высокопроизводительный HTTP/HTTPS прокси-сервер, написанный на Python с использованием асинхронного программирования. Сервер поддерживает как HTTP, так и HTTPS соединения, имеет систему контроля доступа и расширенное логирование.

## Основные возможности
- Поддержка HTTP и HTTPS протоколов
- Система контроля доступа (белый/черный список)
- Расширенное логирование
- Специальная обработка определенных хостов
- Конфигурируемые таймауты и размеры буферов
- Поддержка JavaScript-приложений
- Обработка различных HTTP-методов
- Поддержка сжатия (gzip, deflate)

## Архитектура

### Основные компоненты
1. **ProxyServer** (`src/core/proxy_server.py`)
   - Основной класс сервера
   - Управляет входящими соединениями
   - Инициализирует обработчики клиентов

2. **ClientHandler** (`src/core/client_handler.py`)
   - Обрабатывает клиентские запросы
   - Поддерживает HTTP и HTTPS
   - Реализует специальную обработку для определенных хостов

3. **AccessControl** (`src/security/access_control.py`)
   - Управляет доступом к ресурсам
   - Поддерживает белый и черный списки
   - Кэширует правила доступа

4. **ConfigLoader** (`src/config/config_loader.py`)
   - Загружает конфигурацию из YAML файлов
   - Управляет настройками сервера
   - Предоставляет доступ к конфигурации другим компонентам

5. **ProxyLogger** (`src/logutils/logger.py`)
   - Обеспечивает расширенное логирование
   - Поддерживает различные форматы логов
   - Конфигурируемые поля логирования

### Конфигурация
Конфигурация хранится в YAML файлах:

1. **config.yaml** - основные настройки:
   ```yaml
   server:
     host: "0.0.0.0"
     port: 8080
     timeout: 20
     buffer_size: 4096
   
   logging:
     level: "INFO"
     format: "detailed"
     fields:
       headers: true
       body: true
       response_headers: true
       response_body: true
       duration_ms: true
   
   access_control:
     white_list_file: "rules/white_list.txt"
     black_list_file: "rules/black_list.txt"
     cache_ttl: 300
   
   special_hosts:
     "172.16.10.30":
       direct_connection: true
       timeout: 30
       buffer_size: 8192
   ```

2. **rules/white_list.txt** - список разрешенных доменов
3. **rules/black_list.txt** - список запрещенных доменов

## Как это работает

### 1. Запуск сервера
1. Загружается конфигурация из `config.yaml`
2. Инициализируются компоненты (логгер, контроль доступа)
3. Запускается асинхронный сервер на указанном порту

### 2. Обработка запросов
1. **Получение запроса**
   - Сервер принимает входящее соединение
   - Создается новый `ClientHandler` для обработки
   - Генерируется уникальный ID запроса

2. **Проверка доступа**
   - Извлекается IP клиента и целевой хост
   - Проверяется доступ через `AccessControl`
   - При отказе в доступе возвращается 403 Forbidden

3. **Обработка HTTPS**
   - Для HTTPS запросов устанавливается туннель
   - Создается прямое соединение с целевым сервером
   - Данные передаются в обе стороны

4. **Обработка HTTP**
   - Проверяется, является ли хост специальным
   - Для специальных хостов используется прямая обработка
   - Для обычных запросов используется aiohttp
   - Добавляются необходимые заголовки для поддержки JavaScript

5. **Логирование**
   - Каждый этап обработки логируется
   - Записываются заголовки, тела запросов и ответов
   - Измеряется время выполнения

### 3. Специальная обработка хостов
Для определенных хостов (например, 172.16.10.30):
- Используется прямое соединение без aiohttp
- Устанавливается принудительное закрытие соединения
- Применяются специальные таймауты и размеры буферов

## Установка и запуск

### Требования
- Python 3.7+
- aiohttp
- PyYAML

### Установка зависимостей
```bash
pip install -r requirements.txt
```

### Запуск сервера
```bash
python src/main.py
```

## Настройка

### Конфигурация сервера
- Измените параметры в `config.yaml`
- Настройте белый/черный списки в папке `rules`
- При необходимости добавьте специальные хосты

### Настройка логирования
- Выберите уровень логирования (DEBUG, INFO, WARNING, ERROR)
- Настройте поля для логирования в секции `logging.fields`
- Выберите формат логов (simple/detailed)

## Безопасность
- Регулярно обновляйте списки доступа
- Используйте HTTPS для защиты трафика
- Настройте таймауты для предотвращения DoS-атак
- Контролируйте размеры буферов

## Мониторинг
- Следите за логами для обнаружения проблем
- Контролируйте время выполнения запросов
- Отслеживайте отказы в доступе
- Мониторьте использование ресурсов

## Расширение функциональности
1. Добавление новых специальных хостов:
   - Добавьте конфигурацию в `config.yaml`
   - Реализуйте специальную обработку в `ClientHandler`

2. Изменение правил доступа:
   - Отредактируйте файлы в папке `rules`
   - Настройте TTL кэша в конфигурации

3. Настройка логирования:
   - Измените поля логирования в конфигурации
   - Добавьте новые форматы в `ProxyLogger` 